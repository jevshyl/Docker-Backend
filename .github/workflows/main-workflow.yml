name: main-workflow.yml
on:
  push

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Set up JDK 18
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 18

      - name: Set up Gradle 7.6
        uses: gradle/gradle-build-action@v2
        with:


          gradle-version: 7.6

      - name: Build and SonarQube Scan
        run: gradle build sonarqube --info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

    build:
      needs: sonarqube
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkoutv@3

        - name: Build Docker Image
          run: docker build -t jevshyl/backend-docker-image .

        - name: push Docker Image
          run: docker push jevshyl/backend-docker-image

    deploy:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - name: Deploy to server
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            password: ${{ secrets.PASSWORD }}
            port: 2222
            script: ./deploy.sh




